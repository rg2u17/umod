###########################
## 1. Load libraries ######

library(tidyverse)
library(DataExplorer)
library(data.table)

############################
## 2. Define HTN codes #####

# GP read codes
pmhx_htn_list_readv2_3 <- c(  
  "G2...",	#Hypertensive disease
  "G20..",	#High blood pressure (& [essential hypertension])
  "G200.",	#Malignant essential hypertension
  "G201.",	#Benign essential hypertension
  "G202.",	#Systolic hypertension
  "G203.",	#See XSDSb
  "G20z.",	#Hypertension NOS (& [essential])
  "G22z.",	#(Renal hypertension) or (hypertensive renal disease NOS)
  "Gyu2.",	#[X]Hypertensive diseases
  "Gyu20",	#[X]Other secondary hypertension
  "Gyu21",	#[X]Hypertension secondary to other renal disorders
  "XE0Ub",	#Hypertension
  "XE0Uc",	#Essential hypertension
  "XE0Ud",	#Essential hypertension NOS
  "XE0Ue",	#Hypertensive heart disease NOS without congestive cardiac failure
  "XE0Uf",	#Hypertensive renal disease
  "XE0Ug",	#Hypertensive renal disease NOS
  "XSDSb",	#Diastolic hypertension
  "Xa3fQ",	#Malignant hypertension
  "Xa8HD",	#On treatment for hypertension
  "XaIy8",	#Moderate hypertension control
  "XaIyC",	#Hypertension treatment refused
  "XaIyD",	#Hypertension six month review
  "XaIyE",	#Hypertension annual review
  "XaZWm",	#Stage 1 hypertension (NICE - National Institute for Health and Clinical Excellence 2011)
  "XaZWn",	#Severe hypertension (NICE - National Institute for Health and Clinical Excellence 2011)
  "XaZbz",	#Stage 2 hypertension (NICE - National Institute for Health and Clinical Excellence 2011)
  "Xab9L",	#Stage 1 hypertension (NICE 2011) without evidence of end organ damage
  "Xab9M",	#Stage 1 hypertension (NICE 2011) with evidence of end organ damage
  "6627.",	#Good hypertension control
  "6628.",	#Poor hypertension control
  "662F.",	#Hypertension treatm. started
  "662G."	#Hypertensive treatm.changed
)

# ICD 9 codes
pmhx_htn_list_icd9 <- c(  
  "V811",	#Hypertension
  "401",	#Essential hypertension
  "4010",	#Malignant
  "4011",	#Benign
  "4019",	#Unspecified
  "402",	#Hypertensive heart disease
  "4020",	#Malignant
  "40200",	#Without heart failure
  "40201",	#With heart failure
  "4021",	#Benign
  "40210",	#Without heart failure
  "40211",	#With heart failure
  "4029",	#Unspecified
  "40290",	#Without heart failure
  "40291",	#With heart failure
  "403",	#Hypertensive chronic kidney disease
  "4030",	#Malignant
  "4031",	#Benign
  "4039",	#Unspecified
  "404",	#Hypertensive heart and chronic kidney disease
  "4040",	#Malignant
  "4041",	#Benign
  "4049",	#Unspecified
  "405",	#Secondary hypertension
  "4050",	#Malignant
  "40501",	#Renovascular
  "40509",	#Other
  "4051",	#Benign
  "40511",	#Renovascular
  "40519",	#Other
  "4059",	#Unspecified
  "40591",	#Renovascular
  "40599"	#Other
)

# ICD10 codes
pmhx_htn_list_icd10 <- c(  
  "I10",     #Essential (primary) hypertension
  "I11.0",    #Hypertensive heart disease with heart failure
  "I11.9",    #Hypertensive heart disease without heart failure
  "I12.0",    #Hypertensive chronic kidney disease with stage 5 chronic kidney disease or end stage renal disease
  "I12.9",    #Hypertensive chronic kidney disease with stage 1 through stage 4 chronic kidney disease, or unspecified chronic kidney disease
  "I13.0",    #Hypertensive heart and chronic kidney disease with heart failure and stage 1 through stage 4 chronic kidney disease, or unspecified chronic kidney disease
  "I13.10",   #Hypertensive heart and chronic kidney disease without heart failure, with stage 1 through stage 4 chronic kidney disease, or unspecified chronic kidney disease
  "I13.11",   #Hypertensive heart and chronic kidney disease without heart failure, with stage 5 chronic kidney disease, or end stage renal disease
  "I13.2",    #Hypertensive heart and chronic kidney disease with heart failure and with stage 5 chronic kidney disease, or end stage renal disease
  "I15.0",    #Renovascular hypertension
  "I15.1",    #Hypertension secondary to other renal disorders
  "I15.2",    #Hypertension secondary to endocrine disorders
  "I15.8",    #Other secondary hypertension
  "I15.9",    #Secondary hypertension, unspecified
  "I16.0",    #Hypertensive urgency
  "I16.1",    #Hypertensive emergency
  "I16.9",    #Hypertensive crisis, unspecified
  "I1A.0",    #Resistant hypertension
  "R03.0"    #Elevated blood-pressure reading, without diagnosis of hypertension
)

###########################
## 3. Define PKD codes ####

pmhx_pkd_list_readv2_3 <- c(  
  "PD1..",	#Kidney: [congenital cystic disease] or [fibrocystic] or [polycystic] or [sponge]
  "PD110",	#Autosomal recessive polycystic kidney disease
  "PD111",	#Autosomal dominant polycystic kidney disease
  "PD11z",	#(Polycystic kidney disease NOS) or (cystic kidney disease NEC)
  "PD122",	#See X785r
  "PD12y",	#Medullary cystic disease OS
  "PD12z",	#Medullary cystic disease NOS
  "PD13.",	#Multicystic kidney
  "PD1y.",	#Other specified congenital cystic kidney disease
  "PD1y0",	#Fibrocystic renal: [disease] or [degeneration]
  "PD1y1",	#See X785q
  "PD1yz",	#Other congenital cystic kidney disease NOS
  "PD1z.",	#Congenital cystic kidney disease NOS
  "X785n",	#Adult type polycystic kidney disease type 1
  "X785o",	#Adult type polycystic kidney disease type II
  "X785p",	#Autosomal dominant polycystic kidney disease in childhood
  "X785r",	#Nephronophthisis - medullary cystic disease
  "XE1LM",	#Congenital cystic disease of kidney
  "XE1LN",	#Polycystic kidney disease NOS
  "XE1Nm",	#(Congenital) or (acquired) cystic kidney disease (& [cyst] or [polycystic] or [fibrocystic] kidney)
  "XM19K",	#[EDTA] Polycystic kidneys, infantile (recessive) associated with renal failure
  "XM19L",	#[EDTA] Polycystic kidneys, adult type (dominant) associated with renal failure
  "XM19M"	#[EDTA] Medullary cystic disease, including nephronophthisis, associated with renal failure
)

pmhx_pkd_list_icd9 <- c(  
  "7531",	#Cystic kidney disease
  "75310",	#Cystic kidney disease, unspecified
  "75311",	#Congenital single renal cyst
  "75312",	#Polycystic kidney, unspecified type
  "75313",	#Polycystic kidney, autosomal dominant
  "75314",	#Polycystic kidney, autosomal recessive
  "75315",	#Renal dysplasia
  "75316",	#Medullary cystic kidney
  "75317",	#Medullary sponge kidney
  "75319",	#Other specified cystic kidney disease
  "V1861"	#Polycystic kidney
)

pmhx_pkd_list_icd10 <- c(  
  "Q61.19",   #Other polycystic kidney, infantile type
  "Q61.2",    #Polycystic kidney, adult type
  "Q61.3",    #Polycystic kidney, unspecified
  "Q61.5",    #Medullary cystic kidney
  "Q61.8",    #Other cystic kidney diseases
  "Q61.9"    #Cystic kidney disease, unspecified
)


###########################
## 4. Define DM codes #####

pmhx_dm_list_readv2_3 <- c(  
  "14O8.",  #At risk of diabetes mellitus
  "9OL..",	#Diabetes administration: [monitoring] or [clinic]
  "9OL1.",	#Attends diabetes monitoring
  "9OL2.",	#Refuses diabetes monitoring
  "9OL3.",	#Diabetes monitoring default
  "9OL4.",	#Diabetes monitoring first letter
  "9OL5.",	#Diabetes monitoring second letter
  "9OL6.",	#Diabetes monitoring third letter
  "9OL7.",	#Diabetes monitoring verbal invite
  "9OL8.",	#Diabetes monitoring telephone invite
  "9OL9.",	#Diabetes monitoring deleted
  "9OLA.",	#Diabetes monitored (& check done)
  "C10..",	#Diabetes mellitus
  "C100.",	#Diabetes mellitus with no mention of complication
  "C1000",	#Diabetes mellitus: [juvenile type, with no mention of complication] or [insulin dependent]
  "C1001",	#Diabetes mellitus: [adult onset, with no mention of complication] or [maturity onset] or [non-insulin dependent]
  "C100z",	#Diabetes mellitus NOS with no mention of complication
  "C101.",	#Diabetic ketoacidosis
  "C1010",	#Type 1 diabetes mellitus with ketoacidosis
  "C1011",	#Type 2 diabetes mellitus with ketoacidosis
  "C101y",	#Other specified diabetes mellitus with ketoacidosis
  "C101z",	#Diabetes mellitus NOS with ketoacidosis
  "C102.",	#Diabetes mellitus with hyperosmolar coma
  "C1020",	#Diabetes mellitus, juvenile type, with hyperosmolar coma
  "C1021",	#Diabetes mellitus, adult onset, with hyperosmolar coma
  "C102z",	#Diabetes mellitus NOS with hyperosmolar coma
  "C103.",	#Diabetes mellitus with ketoacidotic coma
  "C1030",	#Type 1 diabetes mellitus with ketoacidotic coma
  "C1031",	#Type II diabetes mellitus with ketoacidotic coma
  "C103y",	#Other specified diabetes mellitus with coma
  "C103z",	#Diabetes mellitus NOS with ketoacidotic coma
  "C104.",	#Diabetes mellitus: [with renal manifestation] or [nephropathy]
  "C1040",	#Diabetes mellitus, juvenile type, with renal manifestation
  "C1041",	#Diabetes mellitus, adult onset, with renal manifestation
  "C104y",	#Other specified diabetes mellitus with renal complications
  "C104z",	#Diabetes mellitus with nephropathy NOS
  "C105.",	#Diabetes mellitus with ophthalmic manifestation
  "C1050",	#Diabetes mellitus, juvenile type, with ophthalmic manifestation
  "C1051",	#Diabetes mellitus, adult onset, with ophthalmic manifestation
  "C105y",	#Other specified diabetes mellitus with ophthalmic complications
  "C105z",	#Diabetes mellitus NOS with ophthalmic manifestation
  "C106.",	#Diabetes mellitus with neurological manifestation: (& [amyotrophy] or [neuropathy] or [polyneuropathy])
  "C1060",	#Diabetes mellitus, juvenile type, with neurological manifestation
  "C1061",	#Diabetes mellitus, adult onset, with neurological manifestation
  "C106y",	#Other specified diabetes mellitus with neurological complications
  "C106z",	#Diabetes mellitus NOS with neurological manifestation
  "C107.",	#Diabetes mellitus with: [gangrene] or [peripheral circulatory disorder]
  "C1070",	#Diabetes mellitus, juvenile type, with peripheral circulatory disorder
  "C1071",	#Diabetes mellitus, adult onset, with peripheral circulatory disorder
  "C1072",	#Diabetes mellitus, adult with gangrene
  "C1073",	#IDDM with peripheral circulatory disorder
  "C1074",	#NIDDM with peripheral circulatory disorder
  "C107y",	#Other specified diabetes mellitus with peripheral circulatory complications
  "C107z",	#Diabetes mellitus NOS with peripheral circulatory disorder
  "C108.",	#See X40J4
  "C1080",	#Type I diabetes mellitus with renal complications
  "C1081",	#Type I diabetes mellitus with ophthalmic complications
  "C1082",	#Type I diabetes mellitus with neurological complications
  "C1083",	#Type I diabetes mellitus with multiple complications
  "C1084",	#See Xa4g7
  "C1085",	#Type I diabetes mellitus with ulcer
  "C1086",	#Type I diabetes mellitus with gangrene
  "C1087",	#Type I diabetes mellitus with retinopathy
  "C1088",	#Type I diabetes mellitus - poor control
  "C1089",	#Type I diabetes mellitus maturity onset
  "C108A",	#Type I diabetes mellitus without complication
  "C108B",	#See XaEnn
  "C108C",	#See XaEno
  "C108D",	#See XaF04
  "C108E",	#See XaFWG
  "C108F",	#See XaFm8
  "C108G",	#See XaFmK
  "C108H",	#See XaFmL
  "C108J",	#See XaFmM
  "C108y",	#Other specified diabetes mellitus with multiple complications
  "C108z",	#Unspecified diabetes mellitus with multiple complications
  "C109.",	#See X40J5
  "C1090",	#Type II diabetes mellitus with renal complications
  "C1091",	#Type II diabetes mellitus with ophthalmic complications
  "C1092",	#Type II diabetes mellitus with neurological complications
  "C1093",	#Type II diabetes mellitus with multiple complications
  "C1094",	#Type II diabetes mellitus with ulcer
  "C1095",	#Type II diabetes mellitus with gangrene
  "C1096",	#Type II diabetes mellitus with retinopathy
  "C1097",	#Type II diabetes mellitus - poor control
  "C10y.",	#Diabetes mellitus with other specified manifestation
  "C10y0",	#Diabetes mellitus, juvenile type, with other specified manifestation
  "C10y1",	#Diabetes mellitus, adult onset, with other specified manifestation
  "C10yy",	#Other specified diabetes mellitus with other specified complications
  "C10yz",	#Diabetes mellitus NOS with other specified manifestation
  "C10z.",	#Diabetes mellitus with unspecified complication
  "C10z0",	#Diabetes mellitus, juvenile type, with unspecified complication
  "C10z1",	#Diabetes mellitus, adult onset, with unspecified complication
  "C10zy",	#Other specified diabetes mellitus with unspecified complications
  "C10zz",	#Diabetes mellitus NOS with unspecified complication
  "XaJlL",	#Secondary pancreatic diabetes mellitus without complication
  "XaELQ", #Type II diabetes mellitus without complication
  "XaELP", #Type I diabetes mellitus without complication
  "XaEnn",
  "XaEno",
  "XaF04",
  "XaFWG",
  "XaFm8",
  "XaFmK",
  "XaFmL",
  "XaFmM",
  "Xa4g7",
  "X40J4"
)  

pmhx_dm_list_icd9 <- c(  
  "249",	#Secondary diabetes mellitus
  "2490",	#Secondary diabetes mellitus without mention of complication
  "2491",	#Secondary diabetes mellitus with ketoacidosis
  "2492",	#Secondary diabetes mellitus with hyperosmolarity
  "2493",	#Secondary diabetes mellitus with other coma
  "2494",	#Secondary diabetes mellitus with renal manifestations
  "2495",	#Secondary diabetes mellitus with ophthalmic manifestations
  "2496",	#Secondary diabetes mellitus with neurological manifestations
  "2497",	#Secondary diabetes mellitus with peripheral circulatory disorders
  "2498",	#Secondary diabetes mellitus with other specified manifestations
  "2499",	#Secondary diabetes mellitus with unspecified complication
  "250",	#Diabetes mellitus
  "2500",	#Diabetes mellitus without mention of complication
  "2501",	#Diabetes with ketoacidosis
  "2502",	#Diabetes with hyperosmolarity
  "2503",	#Diabetes with other coma
  "2504",	#Diabetes with renal manifestations
  "2505",	#Diabetes with ophthalmic manifestations
  "2506",	#Diabetes with neurological manifestations
  "2507",	#Diabetes with peripheral circulatory disorders
  "2508",	#Diabetes with other specified manifestations
  "2509",	#Diabetes with unspecified complication
  "7902",	#Abnormal glucose
  "79021",	#Impaired fasting glucose
  "79022",	#Impaired glucose tolerance test (oral)
  "79029"	#Other abnormal glucose - hyperglycaemia NOS
)  

pmhx_dm_list_icd10 <- c(  
  "R73.0",   #Impaired fasting glucose
  "R73.01",   #Impaired fasting glucose
  "R73.02",   #Impaired glucose tolerance (oral)
  "R73.03",   #Prediabetes
  "R73.09",   #Other abnormal glucose
  "R73.9",    #Hyperglycemia, unspecified
  "E08.0",   #Diabetes mellitus due to underlying condition with hyperosmolarity without nonketotic hyperglycemic-hyperosmolar coma (NKHHC)
  "E08.01",   #Diabetes mellitus due to underlying condition with hyperosmolarity with coma
  "E08.10",   #Diabetes mellitus due to underlying condition with ketoacidosis without coma
  "E08.11",   #Diabetes mellitus due to underlying condition with ketoacidosis with coma
  "E08.21",   #Diabetes mellitus due to underlying condition with diabetic nephropathy
  "E08.22",   #Diabetes mellitus due to underlying condition with diabetic chronic kidney disease
  "E08.29",   #Diabetes mellitus due to underlying condition with other diabetic kidney complication
  "E08.311",  #Diabetes mellitus due to underlying condition with unspecified diabetic retinopathy with macular edema
  "E08.319",  #Diabetes mellitus due to underlying condition with unspecified diabetic retinopathy without macular edema
  "E08.3211", #Diabetes mellitus due to underlying condition with mild nonproliferative diabetic retinopathy with macular edema, right eye
  "E08.3212", #Diabetes mellitus due to underlying condition with mild nonproliferative diabetic retinopathy with macular edema, left eye
  "E08.3213", #Diabetes mellitus due to underlying condition with mild nonproliferative diabetic retinopathy with macular edema, bilateral
  "E08.3219", #Diabetes mellitus due to underlying condition with mild nonproliferative diabetic retinopathy with macular edema, unspecified eye
  "E08.3291", #Diabetes mellitus due to underlying condition with mild nonproliferative diabetic retinopathy without macular edema, right eye
  "E08.3292", #Diabetes mellitus due to underlying condition with mild nonproliferative diabetic retinopathy without macular edema, left eye
  "E08.3293", #Diabetes mellitus due to underlying condition with mild nonproliferative diabetic retinopathy without macular edema, bilateral
  "E08.3299", #Diabetes mellitus due to underlying condition with mild nonproliferative diabetic retinopathy without macular edema, unspecified eye
  "E08.3311", #Diabetes mellitus due to underlying condition with moderate nonproliferative diabetic retinopathy with macular edema, right eye
  "E08.3312", #Diabetes mellitus due to underlying condition with moderate nonproliferative diabetic retinopathy with macular edema, left eye
  "E08.3313", #Diabetes mellitus due to underlying condition with moderate nonproliferative diabetic retinopathy with macular edema, bilateral
  "E08.3319", #Diabetes mellitus due to underlying condition with moderate nonproliferative diabetic retinopathy with macular edema, unspecified eye
  "E08.3391", #Diabetes mellitus due to underlying condition with moderate nonproliferative diabetic retinopathy without macular edema, right eye
  "E08.3392", #Diabetes mellitus due to underlying condition with moderate nonproliferative diabetic retinopathy without macular edema, left eye
  "E08.3393", #Diabetes mellitus due to underlying condition with moderate nonproliferative diabetic retinopathy without macular edema, bilateral
  "E08.3399", #Diabetes mellitus due to underlying condition with moderate nonproliferative diabetic retinopathy without macular edema, unspecified eye
  "E08.3411", #Diabetes mellitus due to underlying condition with severe nonproliferative diabetic retinopathy with macular edema, right eye
  "E08.3412", #Diabetes mellitus due to underlying condition with severe nonproliferative diabetic retinopathy with macular edema, left eye
  "E08.3413", #Diabetes mellitus due to underlying condition with severe nonproliferative diabetic retinopathy with macular edema, bilateral
  "E08.3419", #Diabetes mellitus due to underlying condition with severe nonproliferative diabetic retinopathy with macular edema, unspecified eye
  "E08.3491", #Diabetes mellitus due to underlying condition with severe nonproliferative diabetic retinopathy without macular edema, right eye
  "E08.3492", #Diabetes mellitus due to underlying condition with severe nonproliferative diabetic retinopathy without macular edema, left eye
  "E08.3493", #Diabetes mellitus due to underlying condition with severe nonproliferative diabetic retinopathy without macular edema, bilateral
  "E08.3499", #Diabetes mellitus due to underlying condition with severe nonproliferative diabetic retinopathy without macular edema, unspecified eye
  "E08.3511", #Diabetes mellitus due to underlying condition with proliferative diabetic retinopathy with macular edema, right eye
  "E08.3512", #Diabetes mellitus due to underlying condition with proliferative diabetic retinopathy with macular edema, left eye
  "E08.3513", #Diabetes mellitus due to underlying condition with proliferative diabetic retinopathy with macular edema, bilateral
  "E08.3519", #Diabetes mellitus due to underlying condition with proliferative diabetic retinopathy with macular edema, unspecified eye
  "E08.3521", #Diabetes mellitus due to underlying condition with proliferative diabetic retinopathy with traction retinal detachment involving the macula, right eye
  "E08.3522", #Diabetes mellitus due to underlying condition with proliferative diabetic retinopathy with traction retinal detachment involving the macula, left eye
  "E08.3523", #Diabetes mellitus due to underlying condition with proliferative diabetic retinopathy with traction retinal detachment involving the macula, bilateral
  "E08.3529", #Diabetes mellitus due to underlying condition with proliferative diabetic retinopathy with traction retinal detachment involving the macula, unspecified eye
  "E08.3531", #Diabetes mellitus due to underlying condition with proliferative diabetic retinopathy with traction retinal detachment not involving the macula, right eye
  "E08.3532", #Diabetes mellitus due to underlying condition with proliferative diabetic retinopathy with traction retinal detachment not involving the macula, left eye
  "E08.3533", #Diabetes mellitus due to underlying condition with proliferative diabetic retinopathy with traction retinal detachment not involving the macula, bilateral
  "E08.3539", #Diabetes mellitus due to underlying condition with proliferative diabetic retinopathy with traction retinal detachment not involving the macula, unspecified eye
  "E08.3541", #Diabetes mellitus due to underlying condition with proliferative diabetic retinopathy with combined traction retinal detachment and rhegmatogenous retinal detachment, right eye
  "E08.3542", #Diabetes mellitus due to underlying condition with proliferative diabetic retinopathy with combined traction retinal detachment and rhegmatogenous retinal detachment, left eye
  "E08.3543", #Diabetes mellitus due to underlying condition with proliferative diabetic retinopathy with combined traction retinal detachment and rhegmatogenous retinal detachment, bilateral
  "E08.3549", #Diabetes mellitus due to underlying condition with proliferative diabetic retinopathy with combined traction retinal detachment and rhegmatogenous retinal detachment, unspecified eye
  "E08.3551", #Diabetes mellitus due to underlying condition with stable proliferative diabetic retinopathy, right eye
  "E08.3552", #Diabetes mellitus due to underlying condition with stable proliferative diabetic retinopathy, left eye
  "E08.3553", #Diabetes mellitus due to underlying condition with stable proliferative diabetic retinopathy, bilateral
  "E08.3559", #Diabetes mellitus due to underlying condition with stable proliferative diabetic retinopathy, unspecified eye
  "E08.3591", #Diabetes mellitus due to underlying condition with proliferative diabetic retinopathy without macular edema, right eye
  "E08.3592", #Diabetes mellitus due to underlying condition with proliferative diabetic retinopathy without macular edema, left eye
  "E08.3593", #Diabetes mellitus due to underlying condition with proliferative diabetic retinopathy without macular edema, bilateral
  "E08.3599", #Diabetes mellitus due to underlying condition with proliferative diabetic retinopathy without macular edema, unspecified eye
  "E08.36",   #Diabetes mellitus due to underlying condition with diabetic cataract
  "E08.37X1", #Diabetes mellitus due to underlying condition with diabetic macular edema, resolved following treatment, right eye
  "E08.37X2", #Diabetes mellitus due to underlying condition with diabetic macular edema, resolved following treatment, left eye
  "E08.37X3", #Diabetes mellitus due to underlying condition with diabetic macular edema, resolved following treatment, bilateral
  "E08.37X9", #Diabetes mellitus due to underlying condition with diabetic macular edema, resolved following treatment, unspecified eye
  "E08.39",   #Diabetes mellitus due to underlying condition with other diabetic ophthalmic complication
  "E08.4",   #Diabetes mellitus due to underlying condition with diabetic neuropathy, unspecified
  "E0841",   #Diabetes mellitus due to underlying condition with diabetic mononeuropathy
  "E08.42",   #Diabetes mellitus due to underlying condition with diabetic polyneuropathy
  "E08.43",   #Diabetes mellitus due to underlying condition with diabetic autonomic (poly)neuropathy
  "E08.44",   #Diabetes mellitus due to underlying condition with diabetic amyotrophy
  "E08.49",   #Diabetes mellitus due to underlying condition with other diabetic neurological complication
  "E08.51",   #Diabetes mellitus due to underlying condition with diabetic peripheral angiopathy without gangrene
  "E08.52",   #Diabetes mellitus due to underlying condition with diabetic peripheral angiopathy with gangrene
  "E08.59",   #Diabetes mellitus due to underlying condition with other circulatory complications
  "E08.610",  #Diabetes mellitus due to underlying condition with diabetic neuropathic arthropathy
  "E08.618",  #Diabetes mellitus due to underlying condition with other diabetic arthropathy
  "E08.620",  #Diabetes mellitus due to underlying condition with diabetic dermatitis
  "E08.621",  #Diabetes mellitus due to underlying condition with foot ulcer
  "E08.622",  #Diabetes mellitus due to underlying condition with other skin ulcer
  "E08.628",  #Diabetes mellitus due to underlying condition with other skin complications
  "E08.630",  #Diabetes mellitus due to underlying condition with periodontal disease
  "E08.638",  #Diabetes mellitus due to underlying condition with other oral complications
  "E08.641",  #Diabetes mellitus due to underlying condition with hypoglycemia with coma
  "E08.649",  #Diabetes mellitus due to underlying condition with hypoglycemia without coma
  "E08.65",   #Diabetes mellitus due to underlying condition with hyperglycemia
  "E08.69",   #Diabetes mellitus due to underlying condition with other specified complication
  "E08.8",    #Diabetes mellitus due to underlying condition with unspecified complications
  "E08.9",    #Diabetes mellitus due to underlying condition without complications
  "E10.10",   #Type 1 diabetes mellitus with ketoacidosis without coma
  "E10.11",   #Type 1 diabetes mellitus with ketoacidosis with coma
  "E10.21",   #Type 1 diabetes mellitus with diabetic nephropathy
  "E10.22",   #Type 1 diabetes mellitus with diabetic chronic kidney disease
  "E10.29",   #Type 1 diabetes mellitus with other diabetic kidney complication
  "E10.311",  #Type 1 diabetes mellitus with unspecified diabetic retinopathy with macular edema
  "E10.319",  #Type 1 diabetes mellitus with unspecified diabetic retinopathy without macular edema
  "E10.3211", #Type 1 diabetes mellitus with mild nonproliferative diabetic retinopathy with macular edema, right eye
  "E10.3212", #Type 1 diabetes mellitus with mild nonproliferative diabetic retinopathy with macular edema, left eye
  "E10.3213", #Type 1 diabetes mellitus with mild nonproliferative diabetic retinopathy with macular edema, bilateral
  "E10.3219", #Type 1 diabetes mellitus with mild nonproliferative diabetic retinopathy with macular edema, unspecified eye
  "E10.3291", #Type 1 diabetes mellitus with mild nonproliferative diabetic retinopathy without macular edema, right eye
  "E10.3292", #Type 1 diabetes mellitus with mild nonproliferative diabetic retinopathy without macular edema, left eye
  "E10.3293", #Type 1 diabetes mellitus with mild nonproliferative diabetic retinopathy without macular edema, bilateral
  "E10.3299", #Type 1 diabetes mellitus with mild nonproliferative diabetic retinopathy without macular edema, unspecified eye
  "E10.3311", #Type 1 diabetes mellitus with moderate nonproliferative diabetic retinopathy with macular edema, right eye
  "E10.3312", #Type 1 diabetes mellitus with moderate nonproliferative diabetic retinopathy with macular edema, left eye
  "E10.3313", #Type 1 diabetes mellitus with moderate nonproliferative diabetic retinopathy with macular edema, bilateral
  "E10.3319", #Type 1 diabetes mellitus with moderate nonproliferative diabetic retinopathy with macular edema, unspecified eye
  "E10.3391", #Type 1 diabetes mellitus with moderate nonproliferative diabetic retinopathy without macular edema, right eye
  "E10.3392", #Type 1 diabetes mellitus with moderate nonproliferative diabetic retinopathy without macular edema, left eye
  "E10.3393", #Type 1 diabetes mellitus with moderate nonproliferative diabetic retinopathy without macular edema, bilateral
  "E10.3399", #Type 1 diabetes mellitus with moderate nonproliferative diabetic retinopathy without macular edema, unspecified eye
  "E10.3411", #Type 1 diabetes mellitus with severe nonproliferative diabetic retinopathy with macular edema, right eye
  "E10.3412", #Type 1 diabetes mellitus with severe nonproliferative diabetic retinopathy with macular edema, left eye
  "E10.3413", #Type 1 diabetes mellitus with severe nonproliferative diabetic retinopathy with macular edema, bilateral
  "E10.3419", #Type 1 diabetes mellitus with severe nonproliferative diabetic retinopathy with macular edema, unspecified eye
  "E10.3491", #Type 1 diabetes mellitus with severe nonproliferative diabetic retinopathy without macular edema, right eye
  "E10.3492", #Type 1 diabetes mellitus with severe nonproliferative diabetic retinopathy without macular edema, left eye
  "E10.3493", #Type 1 diabetes mellitus with severe nonproliferative diabetic retinopathy without macular edema, bilateral
  "E10.3499", #Type 1 diabetes mellitus with severe nonproliferative diabetic retinopathy without macular edema, unspecified eye
  "E10.3511", #Type 1 diabetes mellitus with proliferative diabetic retinopathy with macular edema, right eye
  "E10.3512", #Type 1 diabetes mellitus with proliferative diabetic retinopathy with macular edema, left eye
  "E10.3513", #Type 1 diabetes mellitus with proliferative diabetic retinopathy with macular edema, bilateral
  "E10.3519", #Type 1 diabetes mellitus with proliferative diabetic retinopathy with macular edema, unspecified eye
  "E10.3521", #Type 1 diabetes mellitus with proliferative diabetic retinopathy with traction retinal detachment involving the macula, right eye
  "E10.3522", #Type 1 diabetes mellitus with proliferative diabetic retinopathy with traction retinal detachment involving the macula, left eye
  "E10.3523", #Type 1 diabetes mellitus with proliferative diabetic retinopathy with traction retinal detachment involving the macula, bilateral
  "E10.3529", #Type 1 diabetes mellitus with proliferative diabetic retinopathy with traction retinal detachment involving the macula, unspecified eye
  "E10.3531", #Type 1 diabetes mellitus with proliferative diabetic retinopathy with traction retinal detachment not involving the macula, right eye
  "E10.3532", #Type 1 diabetes mellitus with proliferative diabetic retinopathy with traction retinal detachment not involving the macula, left eye
  "E10.3533", #Type 1 diabetes mellitus with proliferative diabetic retinopathy with traction retinal detachment not involving the macula, bilateral
  "E10.3539", #Type 1 diabetes mellitus with proliferative diabetic retinopathy with traction retinal detachment not involving the macula, unspecified eye
  "E10.3541", #Type 1 diabetes mellitus with proliferative diabetic retinopathy with combined traction retinal detachment and rhegmatogenous retinal detachment, right eye
  "E10.3542", #Type 1 diabetes mellitus with proliferative diabetic retinopathy with combined traction retinal detachment and rhegmatogenous retinal detachment, left eye
  "E10.3543", #Type 1 diabetes mellitus with proliferative diabetic retinopathy with combined traction retinal detachment and rhegmatogenous retinal detachment, bilateral
  "E10.3549", #Type 1 diabetes mellitus with proliferative diabetic retinopathy with combined traction retinal detachment and rhegmatogenous retinal detachment, unspecified eye
  "E10.3551", #Type 1 diabetes mellitus with stable proliferative diabetic retinopathy, right eye
  "E10.3552", #Type 1 diabetes mellitus with stable proliferative diabetic retinopathy, left eye
  "E10.3553", #Type 1 diabetes mellitus with stable proliferative diabetic retinopathy, bilateral
  "E10.3559", #Type 1 diabetes mellitus with stable proliferative diabetic retinopathy, unspecified eye
  "E10.3591", #Type 1 diabetes mellitus with proliferative diabetic retinopathy without macular edema, right eye
  "E10.3592", #Type 1 diabetes mellitus with proliferative diabetic retinopathy without macular edema, left eye
  "E10.3593", #Type 1 diabetes mellitus with proliferative diabetic retinopathy without macular edema, bilateral
  "E10.3599", #Type 1 diabetes mellitus with proliferative diabetic retinopathy without macular edema, unspecified eye
  "E10.36",   #Type 1 diabetes mellitus with diabetic cataract
  "E10.37X1", #Type 1 diabetes mellitus with diabetic macular edema, resolved following treatment, right eye
  "E10.37X2", #Type 1 diabetes mellitus with diabetic macular edema, resolved following treatment, left eye
  "E10.37X3", #Type 1 diabetes mellitus with diabetic macular edema, resolved following treatment, bilateral
  "E10.37X9", #Type 1 diabetes mellitus with diabetic macular edema, resolved following treatment, unspecified eye
  "E10.39",   #Type 1 diabetes mellitus with other diabetic ophthalmic complication
  "E10.4",   #Type 1 diabetes mellitus with diabetic neuropathy, unspecified
  "E10.41",   #Type 1 diabetes mellitus with diabetic mononeuropathy
  "E10.42",   #Type 1 diabetes mellitus with diabetic polyneuropathy
  "E10.43",   #Type 1 diabetes mellitus with diabetic autonomic (poly)neuropathy
  "E10.44",   #Type 1 diabetes mellitus with diabetic amyotrophy
  "E10.49",   #Type 1 diabetes mellitus with other diabetic neurological complication
  "E10.51",   #Type 1 diabetes mellitus with diabetic peripheral angiopathy without gangrene
  "E10.52",   #Type 1 diabetes mellitus with diabetic peripheral angiopathy with gangrene
  "E10.59",   #Type 1 diabetes mellitus with other circulatory complications
  "E10.61",  #Type 1 diabetes mellitus with diabetic neuropathic arthropathy
  "E10.618",  #Type 1 diabetes mellitus with other diabetic arthropathy
  "E10.62",  #Type 1 diabetes mellitus with diabetic dermatitis
  "E10.621",  #Type 1 diabetes mellitus with foot ulcer
  "E10.622",  #Type 1 diabetes mellitus with other skin ulcer
  "E10.628",  #Type 1 diabetes mellitus with other skin complications
  "E10.63",  #Type 1 diabetes mellitus with periodontal disease
  "E10.638",  #Type 1 diabetes mellitus with other oral complications
  "E10.641",  #Type 1 diabetes mellitus with hypoglycemia with coma
  "E10.649",  #Type 1 diabetes mellitus with hypoglycemia without coma
  "E10.65",   #Type 1 diabetes mellitus with hyperglycemia
  "E10.69",   #Type 1 diabetes mellitus with other specified complication
  "E10.8",    #Type 1 diabetes mellitus with unspecified complications
  "E10.9",    #Type 1 diabetes mellitus without complications
  "E11.0",   #Type 2 diabetes mellitus with hyperosmolarity without nonketotic hyperglycemic-hyperosmolar coma (NKHHC)
  "E11.01",   #Type 2 diabetes mellitus with hyperosmolarity with coma
  "E11.10",   #Type 2 diabetes mellitus with ketoacidosis without coma
  "E11.11",   #Type 2 diabetes mellitus with ketoacidosis with coma
  "E11.21",   #Type 2 diabetes mellitus with diabetic nephropathy
  "E11.22",   #Type 2 diabetes mellitus with diabetic chronic kidney disease
  "E11.29",   #Type 2 diabetes mellitus with other diabetic kidney complication
  "E11.311",  #Type 2 diabetes mellitus with unspecified diabetic retinopathy with macular edema
  "E11.319",  #Type 2 diabetes mellitus with unspecified diabetic retinopathy without macular edema
  "E11.3211", #Type 2 diabetes mellitus with mild nonproliferative diabetic retinopathy with macular edema, right eye
  "E11.3212", #Type 2 diabetes mellitus with mild nonproliferative diabetic retinopathy with macular edema, left eye
  "E11.3213", #Type 2 diabetes mellitus with mild nonproliferative diabetic retinopathy with macular edema, bilateral
  "E11.3219", #Type 2 diabetes mellitus with mild nonproliferative diabetic retinopathy with macular edema, unspecified eye
  "E11.3291", #Type 2 diabetes mellitus with mild nonproliferative diabetic retinopathy without macular edema, right eye
  "E11.3292", #Type 2 diabetes mellitus with mild nonproliferative diabetic retinopathy without macular edema, left eye
  "E11.3293", #Type 2 diabetes mellitus with mild nonproliferative diabetic retinopathy without macular edema, bilateral
  "E11.3299", #Type 2 diabetes mellitus with mild nonproliferative diabetic retinopathy without macular edema, unspecified eye
  "E11.3311", #Type 2 diabetes mellitus with moderate nonproliferative diabetic retinopathy with macular edema, right eye
  "E11.3312", #Type 2 diabetes mellitus with moderate nonproliferative diabetic retinopathy with macular edema, left eye
  "E11.3313", #Type 2 diabetes mellitus with moderate nonproliferative diabetic retinopathy with macular edema, bilateral
  "E11.3319", #Type 2 diabetes mellitus with moderate nonproliferative diabetic retinopathy with macular edema, unspecified eye
  "E11.3391", #Type 2 diabetes mellitus with moderate nonproliferative diabetic retinopathy without macular edema, right eye
  "E11.3392", #Type 2 diabetes mellitus with moderate nonproliferative diabetic retinopathy without macular edema, left eye
  "E11.3393", #Type 2 diabetes mellitus with moderate nonproliferative diabetic retinopathy without macular edema, bilateral
  "E11.3399", #Type 2 diabetes mellitus with moderate nonproliferative diabetic retinopathy without macular edema, unspecified eye
  "E11.3411", #Type 2 diabetes mellitus with severe nonproliferative diabetic retinopathy with macular edema, right eye
  "E11.3412", #Type 2 diabetes mellitus with severe nonproliferative diabetic retinopathy with macular edema, left eye
  "E11.3413", #Type 2 diabetes mellitus with severe nonproliferative diabetic retinopathy with macular edema, bilateral
  "E11.3419", #Type 2 diabetes mellitus with severe nonproliferative diabetic retinopathy with macular edema, unspecified eye
  "E11.3491", #Type 2 diabetes mellitus with severe nonproliferative diabetic retinopathy without macular edema, right eye
  "E11.3492", #Type 2 diabetes mellitus with severe nonproliferative diabetic retinopathy without macular edema, left eye
  "E11.3493", #Type 2 diabetes mellitus with severe nonproliferative diabetic retinopathy without macular edema, bilateral
  "E11.3499", #Type 2 diabetes mellitus with severe nonproliferative diabetic retinopathy without macular edema, unspecified eye
  "E11.3511", #Type 2 diabetes mellitus with proliferative diabetic retinopathy with macular edema, right eye
  "E11.3512", #Type 2 diabetes mellitus with proliferative diabetic retinopathy with macular edema, left eye
  "E11.3513", #Type 2 diabetes mellitus with proliferative diabetic retinopathy with macular edema, bilateral
  "E11.3519", #Type 2 diabetes mellitus with proliferative diabetic retinopathy with macular edema, unspecified eye
  "E11.3521", #Type 2 diabetes mellitus with proliferative diabetic retinopathy with traction retinal detachment involving the macula, right eye
  "E11.3522", #Type 2 diabetes mellitus with proliferative diabetic retinopathy with traction retinal detachment involving the macula, left eye
  "E11.3523", #Type 2 diabetes mellitus with proliferative diabetic retinopathy with traction retinal detachment involving the macula, bilateral
  "E11.3529", #Type 2 diabetes mellitus with proliferative diabetic retinopathy with traction retinal detachment involving the macula, unspecified eye
  "E11.3531", #Type 2 diabetes mellitus with proliferative diabetic retinopathy with traction retinal detachment not involving the macula, right eye
  "E11.3532", #Type 2 diabetes mellitus with proliferative diabetic retinopathy with traction retinal detachment not involving the macula, left eye
  "E11.3533", #Type 2 diabetes mellitus with proliferative diabetic retinopathy with traction retinal detachment not involving the macula, bilateral
  "E11.3539", #Type 2 diabetes mellitus with proliferative diabetic retinopathy with traction retinal detachment not involving the macula, unspecified eye
  "E11.3541", #Type 2 diabetes mellitus with proliferative diabetic retinopathy with combined traction retinal detachment and rhegmatogenous retinal detachment, right eye
  "E11.3542", #Type 2 diabetes mellitus with proliferative diabetic retinopathy with combined traction retinal detachment and rhegmatogenous retinal detachment, left eye
  "E11.3543", #Type 2 diabetes mellitus with proliferative diabetic retinopathy with combined traction retinal detachment and rhegmatogenous retinal detachment, bilateral
  "E11.3549", #Type 2 diabetes mellitus with proliferative diabetic retinopathy with combined traction retinal detachment and rhegmatogenous retinal detachment, unspecified eye
  "E11.3551", #Type 2 diabetes mellitus with stable proliferative diabetic retinopathy, right eye
  "E11.3552", #Type 2 diabetes mellitus with stable proliferative diabetic retinopathy, left eye
  "E11.3553", #Type 2 diabetes mellitus with stable proliferative diabetic retinopathy, bilateral
  "E11.3559", #Type 2 diabetes mellitus with stable proliferative diabetic retinopathy, unspecified eye
  "E11.3591", #Type 2 diabetes mellitus with proliferative diabetic retinopathy without macular edema, right eye
  "E11.3592", #Type 2 diabetes mellitus with proliferative diabetic retinopathy without macular edema, left eye
  "E11.3593", #Type 2 diabetes mellitus with proliferative diabetic retinopathy without macular edema, bilateral
  "E11.3599", #Type 2 diabetes mellitus with proliferative diabetic retinopathy without macular edema, unspecified eye
  "E11.36",   #Type 2 diabetes mellitus with diabetic cataract
  "E11.37X1", #Type 2 diabetes mellitus with diabetic macular edema, resolved following treatment, right eye
  "E11.37X2", #Type 2 diabetes mellitus with diabetic macular edema, resolved following treatment, left eye
  "E11.37X3", #Type 2 diabetes mellitus with diabetic macular edema, resolved following treatment, bilateral
  "E11.37X9", #Type 2 diabetes mellitus with diabetic macular edema, resolved following treatment, unspecified eye
  "E11.39",   #Type 2 diabetes mellitus with other diabetic ophthalmic complication
  "E11.4",   #Type 2 diabetes mellitus with diabetic neuropathy, unspecified
  "E11.41",   #Type 2 diabetes mellitus with diabetic mononeuropathy
  "E11.42",   #Type 2 diabetes mellitus with diabetic polyneuropathy
  "E11.43",   #Type 2 diabetes mellitus with diabetic autonomic (poly)neuropathy
  "E11.44",   #Type 2 diabetes mellitus with diabetic amyotrophy
  "E11.49",   #Type 2 diabetes mellitus with other diabetic neurological complication
  "E11.51",   #Type 2 diabetes mellitus with diabetic peripheral angiopathy without gangrene
  "E11.52",   #Type 2 diabetes mellitus with diabetic peripheral angiopathy with gangrene
  "E11.59",   #Type 2 diabetes mellitus with other circulatory complications
  "E11.610",  #Type 2 diabetes mellitus with diabetic neuropathic arthropathy
  "E11.618",  #Type 2 diabetes mellitus with other diabetic arthropathy
  "E11.620",  #Type 2 diabetes mellitus with diabetic dermatitis
  "E11.621",  #Type 2 diabetes mellitus with foot ulcer
  "E11.622",  #Type 2 diabetes mellitus with other skin ulcer
  "E11.628",  #Type 2 diabetes mellitus with other skin complications
  "E11.630",  #Type 2 diabetes mellitus with periodontal disease
  "E11.638",  #Type 2 diabetes mellitus with other oral complications
  "E11.641",  #Type 2 diabetes mellitus with hypoglycemia with coma
  "E11.649",  #Type 2 diabetes mellitus with hypoglycemia without coma
  "E11.65",   #Type 2 diabetes mellitus with hyperglycemia
  "E11.69",   #Type 2 diabetes mellitus with other specified complication
  "E11.8",    #Type 2 diabetes mellitus with unspecified complications
  "E11.9"    #Type 2 diabetes mellitus without complications
)  

###########################
## 5. Get GP data #########

pmhx_gp_data <-
  recurrence_gp_data 

umod_cohort_gp <- pmhx_gp_data %>% mutate(
  htn = case_when(
    (read_v2_code  %in% pmhx_htn_list_readv2_3 | 
       ctv3_read_v3_code %in% pmhx_htn_list_readv2_3) ~ 1,
    TRUE ~ 0),
  dm = case_when(
    (read_v2_code  %in% pmhx_dm_list_readv2_3 | 
       ctv3_read_v3_code %in% pmhx_dm_list_readv2_3) ~ 1,
    TRUE ~ 0),
  pkd = case_when(
    (read_v2_code  %in% pmhx_pkd_list_readv2_3 | 
       ctv3_read_v3_code %in% pmhx_pkd_list_readv2_3) ~ 1,
    TRUE ~ 0),   
  .keep = "all"
)  %>% subset(select = -c(date_clinical_code_was_entered,
                          read_v2_code,
                          ctv3_read_v3_code,
                          value_recorded_1,
                          value_recorded_2,
                          value_recorded_3))


###########################
## 6. Get ICD data ########

umod_cohort_icd <- icd_dates4_long_diagnoses %>% mutate(
  htn = case_when(
    (icd_code  %in% pmhx_htn_list_icd9 | 
       icd_code %in% pmhx_htn_list_icd10) ~ 1,
    TRUE ~ 0), 
  dm = case_when(
    (icd_code  %in% pmhx_dm_list_icd9 | 
       icd_code %in% pmhx_dm_list_icd10) ~ 1,
    TRUE ~ 0), 
  pkd = case_when(
    (icd_code  %in% pmhx_pkd_list_icd9 | 
       icd_code %in% pmhx_pkd_list_icd10) ~ 1,
    TRUE ~ 0), 
  resistant_htn = case_when(
    icd_code == "I1A.0" ~ 1, 
    TRUE ~ 0
  ),
  .keep = "all"
) %>% subset(select = -c(icd_code,
                         date_of_code,
                         description))

umod_resistant_htn_cohort <-
  umod_cohort_icd %>% subset(select = c(participant_id,
                                        resistant_htn)) %>% group_by(participant_id) %>%
  summarize(resistant_htn = max(resistant_htn)) %>%
  ungroup()

# There are no patients with ICD10 code for resistant hypertension
table(umod_resistant_htn_cohort$resistant_htn)

##################################
## 7. Merge GP / ICD datasets ####

umod_cohort_icd <- umod_cohort_icd %>% subset(select = -resistant_htn)

umod_cohort <- rbind(umod_cohort_gp,
                     umod_cohort_icd) %>% as_tibble()

# Create function to ensure that a positive code overrides negative codes
custom_max <- function(x) {
  if (any(x == 1, na.rm = TRUE)) {
    return(1)
  } else if (any(x == 0, na.rm = TRUE)) {
    return(0)
  } else {
    return(NA)
  }
}

umod_cohort_cleaned <- umod_cohort %>%
  group_by(participant_id) %>%
  summarize(across(where(is.numeric), ~custom_max(.x))) %>%
  ungroup()

##################################
## 8. Get bloods data ####

demographics <-
  read.csv("~/Desktop/Howles/Recurrent Kidney stones/R/Recurrence/biochem_participant.csv",
           na.strings = c("", " ", ".","NA", "N/A", "NULL")) %>% as_tibble() %>% janitor::clean_names()

additional_bloods <- read.csv("~/Desktop/Howles/Recurrent Kidney stones/R/Recurrence/additional_bloods_participant.csv",
                              na.strings = c("", " ", ".","NA", "N/A", "NULL")) %>% as_tibble() %>% janitor::clean_names()

umod_bloods <- demographics %>% mutate(
  calcium = coalesce(calcium_instance_0, calcium_instance_1),
  albumin = coalesce(albumin_instance_0, albumin_instance_1),
  vitamin_d = coalesce(vitamin_d_instance_0, vitamin_d_instance_1),
  phosphate = coalesce(phosphate_instance_0, phosphate_instance_1),
  waist_circumference = coalesce(waist_circumference_instance_0, 
                                 waist_circumference_instance_1,
                                 waist_circumference_instance_2,
                                 waist_circumference_instance_3),
  creatinine = coalesce(creatinine_instance_0, creatinine_instance_1),
  hdl = coalesce(hdl_cholesterol_instance_0, hdl_cholesterol_instance_1),
  triglycerides = coalesce(triglycerides_instance_0, triglycerides_instance_1),
  ldl = coalesce(ldl_direct_instance_0, ldl_direct_instance_1),
  hba1c = coalesce(glycated_haemoglobin_hb_a1c_instance_0, glycated_haemoglobin_hb_a1c_instance_1),
  cystatin_c = coalesce(cystatin_c_instance_0, cystatin_c_instance_1),
  alp = coalesce(alkaline_phosphatase_instance_0, alkaline_phosphatase_instance_1),
  urea = coalesce(urea_instance_0, urea_instance_1),
  na_urine = coalesce(sodium_in_urine_instance_0, sodium_in_urine_instance_1),
  k_urine = coalesce(potassium_in_urine_instance_0, potassium_in_urine_instance_1),
  creatinine_urine = coalesce(creatinine_enzymatic_in_urine_instance_0, creatinine_enzymatic_in_urine_instance_1),
  hip_circumference = coalesce(hip_circumference_instance_0,
                               hip_circumference_instance_1,
                               hip_circumference_instance_2,
                               hip_circumference_instance_3),
  bmi = coalesce(body_mass_index_bmi_instance_0,
                 body_mass_index_bmi_instance_1,
                 body_mass_index_bmi_instance_2,
                 body_mass_index_bmi_instance_3),
  urate = coalesce(urate_instance_0,
                   urate_instance_1)
  ,
  .keep = "unused"
) %>% mutate(
  whr = hip_circumference/waist_circumference,
  adjca = calcium + (0.02*(40-albumin))
)

umod_bloods$sex <- as.factor(umod_bloods$sex)
umod_bloods$sex <- recode_factor(umod_bloods$sex,
                                 "0" = "Female",
                                 "1" = "Male")

umod_extra_bloods <- additional_bloods %>% mutate(
  alt = coalesce(alanine_aminotransferase_instance_0, alanine_aminotransferase_instance_1),
  glucose = coalesce(glucose_instance_0, glucose_instance_1),
  ast = coalesce(aspartate_aminotransferase_instance_0, aspartate_aminotransferase_instance_1),
  bilirubin = coalesce(direct_bilirubin_instance_0, direct_bilirubin_instance_1),
  .keep = "unused"
)

umod_bloods <- umod_bloods %>% left_join(umod_extra_bloods, by = c("participant_id" = "participant_id"))

#################################
## 9. Get manual BP readings ####

diet_data_participant <- read.csv("~/Desktop/Howles/Recurrent Kidney stones/R/Dietary Analysis/diet_data_updated__participant.csv",
                                  na.strings = c("", " ", ".","NA", "N/A", "NULL")) %>% as_tibble() %>% janitor::clean_names()

manual_bp <-
  diet_data_participant %>% subset(
    select = -c(
      age_at_recruitment,
      date_n20_first_reported_calculus_of_kidney_and_ureter,
      date_n22_first_reported_calculus_of_urinary_tract_in_diseases_classified_elsewhere,
      date_n23_first_reported_unspecified_renal_colic,
      diagnoses_icd10,
      date_of_first_in_patient_diagnosis_icd10_array_0,
      date_of_first_in_patient_diagnosis_icd10_array_1,
      sex,
      blood_pressure_device_id_instance_0,
      never_eat_eggs_dairy_wheat_sugar_instance_0,
      met_minutes_per_week_for_moderate_activity_instance_0,
      met_minutes_per_week_for_vigorous_activity_instance_0,
      summed_minutes_activity_instance_0,
      blood_pressure_manual_sphygmomanometer_device_id_instance_0,
      above_moderate_vigorous_recommendation_instance_0,
      above_moderate_vigorous_walking_recommendation_instance_0,
      townsend_deprivation_index_at_recruitment,
      water_intake_instance_0,
      major_dietary_changes_in_the_last_5_years_instance_0
    )
  ) %>% as_tibble()

manual_bp$year_of_birth <- as.character(manual_bp$year_of_birth)
manual_bp$month_of_birth <- as.character(manual_bp$month_of_birth)
manual_bp$date_of_end_stage_renal_disease_report <-
  as.Date(manual_bp$date_of_end_stage_renal_disease_report)

manual_bp <- manual_bp %>% mutate(
  dob = paste("1", month_of_birth, year_of_birth, sep = " - "),
  diastolic_bp = if_else(
    !is.na(
      diastolic_blood_pressure_automated_reading_instance_0_array_0
    ),
    diastolic_blood_pressure_automated_reading_instance_0_array_0,
    if_else(
      !is.na(diastolic_blood_pressure_manual_reading_instance_0_array_0),
      diastolic_blood_pressure_manual_reading_instance_0_array_0,
      NA_real_
    )
  ),
  systolic_bp = if_else(
    !is.na(
      systolic_blood_pressure_automated_reading_instance_0_array_0
    ),
    systolic_blood_pressure_automated_reading_instance_0_array_0,
    if_else(
      !is.na(systolic_blood_pressure_manual_reading_instance_0_array_0),
      systolic_blood_pressure_manual_reading_instance_0_array_0,
      NA_real_
    )
  ),
  CKD = ifelse(!is.na(date_of_end_stage_renal_disease_report),
               "yes",
               "no"),
  .keep = "all"
) %>% subset(
  select = c(
    participant_id,
    dob,
    diastolic_bp,
    systolic_bp,
    CKD,
    date_of_end_stage_renal_disease_report
  )
)

manual_bp$dob <- as.Date(manual_bp$dob,
                         format = "%d - %m - %Y")
manual_bp$CKD <- factor(manual_bp$CKD,
                        levels = c("yes",
                                   "no"))

manual_bp <-
  manual_bp %>% left_join(overall_follow_up, by = c("participant_id" = "participant_id")) %>% mutate(CKD_date = as.Date(ifelse(
    !is.na(date_of_end_stage_renal_disease_report),
    date_of_end_stage_renal_disease_report,
    last_date
  ))) %>% mutate(time_to_CKD = difftime(CKD_date, dob, units = "days") / 365 #Time difference between birth + CKD or last follow-up date, divided by 365 to make into years
                 ,
                 .keep = "unused") %>% subset(select = -date_of_end_stage_renal_disease_report)  

#########################################
## 10. Merge all datasets and explore ####

umod_cohort_complete <-
  umod_cohort_cleaned %>% left_join(umod_bloods, by = c("participant_id" = "participant_id")) %>% left_join(manual_bp,
                                                                                                            by = c("participant_id" = "participant_id"))
str(umod_cohort_complete)

table(umod_cohort_complete$htn)
plot_missing(umod_cohort_complete)

umod_cohort_complete <-
  umod_cohort_complete %>% mutate(CKD_numeric = ifelse(CKD == "yes", 1, ifelse(CKD == "no", 0, NA)))

umod_cohort_complete$CKD_numeric <- as.integer(umod_cohort_complete$CKD_numeric)
umod_cohort_complete$time_to_CKD <- as.numeric(umod_cohort_complete$time_to_CKD)

km_ckd <- surv_fit(Surv(time_to_CKD, CKD_numeric) ~ pkd, data=umod_cohort_complete) 
ggsurvplot(km_ckd,
           data = umod_cohort_complete,
           risk.table = TRUE,
           surv.median.line = "hv",
           conf.int = TRUE,
           censor = FALSE,
           tables.theme = theme_cleantable(),
           break.time.by = 5,
           xlab = "Time (years)",
           xlim = c(0,80),
           title = "Time to First Recurrence")

#########################################
## 11. Calculate eGFR ####################

gfr_function <-
  function(creatinine,
           cystatin_c,
           age_at_recruitment,
           A,
           B,
           C,
           D,
           sex) {
    gfr <-
      ifelse(sex == "Female",
             0.963 * (135 * ((creatinine / A) ^ B) * ((cystatin_c / C) ^ D) * (0.9961 ^ age_at_recruitment)),
             (135 * ((creatinine / A) ^ B) * ((cystatin_c / C) ^ D) * (0.9961 ^ age_at_recruitment)))
    return(gfr)
  }



umod_cohort_complete <- umod_cohort_complete %>% mutate(
  A = ifelse(sex == "Female", 0.7,
             ifelse(sex == "Male", 0.9, NA)),
  B = ifelse(
    sex == "Female" & creatinine <= 0.7,
    -0.219,
    ifelse(
      sex == "Male" & creatinine <= 0.7,
      -0.144,
      ifelse(creatinine > 0.7,-0.544, NA)
    )
  ),
  C = 0.8,
  D = ifelse(cystatin_c > 0.8,-0.778,
             ifelse(cystatin_c <= 0.8,-0.323, NA)),
  .keep = "all"
) %>% mutate(
  gfr = gfr_function(
    creatinine = creatinine,
    cystatin_c = cystatin_c,
    age_at_recruitment = age_at_recruitment,
    A = A,
    B = B,
    C = C,
    D = D,
    sex = sex
  )
) %>% subset(select = -c(A, B, C, D))

#########################################
## 12. Write pheno file #################

write.table(
  umod_cohort_complete,
  "~/Desktop/umod_cohort.txt", 
  sep ="\t",
  row.names = FALSE,
  quote = FALSE
)

#########################################
## 13. Import SNP info  #################

# Create Summary of all SNPs associated with UMOD from dbSNP for assembly 38
# Import summary

umod_snps <- data.table::fread("~/Desktop/Howles/Recurrent Kidney Stones/Umod/umod_snp.txt")
umod_snps <- umod_snps %>% mutate(
  snp_id = paste("rs", snp_id, sep = ""),
  chr = 16
)

umod_snps$pos <- as.integer(umod_snps$pos)

# UMOD Exon 3 position: 20348435 - 20349212
# UMOD Exon 4 position: 20348223 - 20348330

umod_snps_exon3 <- umod_snps %>% filter(pos >= 20348435 & pos <= 20349212)
umod_snps_exon4 <- umod_snps %>% filter(pos >= 20348223 & pos <= 20348330)

umod_snps_exons3_4 <- rbind(umod_snps_exon3,
                            umod_snps_exon4) %>% filter(clinical_significance == "pathogenic" | clinical_significance == "likely-pathogenic")

# Can filter for LP/P variants with this %>% filter(clinical_significance == "pathogenic" | clinical_significance == "likely-pathogenic")
# or remove LB/B variants with this %>% filter(clinical_significance != "benign" | clinical_significance == "likely-benign")

# This will give you a list of snps
umod_snp_list <- umod_snps_exons3_4 %>% separate(variation, c("A", "B")) %>% mutate(
  snp = paste("16",pos, A, B,  sep = ":")
) %>% subset(select = snp)

# This will give you a list of snp rsids
umod_rs_list <- umod_snps_exons3_4 %>% subset(select = snp_id) 


# Write snp list for filtering
write.table(
  umod_snp_list,
  "~/Desktop/umod_snp_list.txt", 
  sep ="\t",
  row.names = FALSE,
  col.names = FALSE,
  quote = FALSE
)

###########################################
## 14. Filter Chr16 file for UMOD snps ####

# For use in UKB / AoU / Equivalent Biobank

# Bash - do not run in R
plink \
--bfile chr16 \ #change to chromosome 16 file of interest
--extract umod_snp_list.txt \
--make-bed \
--maf 0.001 \ # Filter very rare variants as done in Genomics England Exomiser
--recode AD \ # Causes an additive (0/1/2) + dominant (het = 1, otherwise 0) component file, suitable for loading from R, to be generated.
--out chr16_umod_filtered

# plink --bfile ukb23419_c16_b0_v1 --extract umod_snp_list.txt --maf 0.001 --recode AD --make-bed --out chr16_umod_filtered

#download raw files and import into R



#########################################
## 15. Import raw genotype file #########

umod_genotype <- data.table::fread("~/Desktop/Howles/Recurrent Kidney Stones/Umod/chr16_umod_filtered.raw")
umod_genotype_filtered <- umod_genotype %>% subset(`16:20348557:G:A_A` == 1 |
                                                     `16:20348557:G:A_HET` == 1 |
                                                     `16:20349023:A:G_G` == 1 |
                                                     `16:20349023:A:G_HET` == 1
                                                     )

###################################################
## 16. Merge Genotype and Phenotype files #########

# Merge
umod_geno_pheno <- umod_genotype_filtered %>% left_join(umod_cohort_complete, by = c("IID" = "participant_id"))

# How many with CKD?
table(umod_geno_pheno$CKD)


